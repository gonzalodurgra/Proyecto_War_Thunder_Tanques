<div class="container">
  
  <!-- ================================================================ -->
  <!-- HEADER CON AUTENTICACI√ìN -->
  <!-- ================================================================ -->
  <div class="app-header">
    <h1 class="header-title">
      <span class="title-full">üéÆ War Thunder - Base de Datos de Tanques</span>
      <span class="title-short">üéÆ War Thunder DB</span>
      <span class="title-mobile">üéÆ WT Tanques</span>
    </h1>
    
    <div class="user-section">
      @if (isAuthenticated) {
        <!-- Usuario autenticado -->
        <div class="user-menu">
          <button class="user-button" (click)="toggleMenuUsuario()">
            <span class="user-icon">üë§</span>
            <span class="username">{{ currentUsername }}</span>
            <span class="dropdown-icon">‚ñº</span>
          </button>
          
          @if (mostrarMenuUsuario) {
            <div class="dropdown-menu">
              <div class="user-info">
                <p><strong>{{ currentUsername }}</strong></p>
                <p class="user-role">
                  @if (isAdmin) {
                    <span class="badge-admin">üëë Administrador</span>
                  } @else {
                    <span>üìù Editor</span>
                  }
                </p>
              </div>
              
              @if (isAdmin) {
                <button class="dropdown-item" (click)="irAPanelAdmin()">
                  üõ°Ô∏è Panel de Admin
                </button>
              }
              
              <button class="dropdown-item logout" (click)="logout()">
                üö™ Cerrar Sesi√≥n
              </button>
            </div>
          }
        </div>
      } @else {
        <!-- Usuario no autenticado -->
        <div class="guest-section">
          <span class="guest-badge">üëÅÔ∏è Modo Lectura</span>
          <button class="btn-login-header" (click)="irALogin()">
            <span class="btn-text-full">Iniciar Sesi√≥n</span>
            <span class="btn-text-short">Login</span>
          </button>
        </div>
      }
    </div>
  </div>

  <!-- ================================================================ -->
  <!-- SECCI√ìN DE FILTROS -->
  <!-- ================================================================ -->
  <div class="filtros-container">
    <div class="filtros-header">
      <h2>Filtros</h2>
      
      @if (isAuthenticated) {
        <button (click)="crearNuevoTanque()" class="btn-crear-nuevo">
          ‚ûï Crear Nuevo Tanque
        </button>
      }
    </div>
    
    <div class="filtro">
      <label for="filtroNacion">Naci√≥n:</label>
      <select 
        id="filtroNacion" 
        [(ngModel)]="filtroNacion" 
        (change)="filtrarPorNacion()">
        <option value="">Todas las naciones</option>
        @for (nacion of naciones; track nacion) {
          <option [value]="nacion">{{ nacion }}</option>
        }
      </select>
    </div>

    <div class="filtro">
      <label for="filtroBusqueda">Buscar:</label>
      <input 
        type="text" 
        id="filtroBusqueda" 
        [(ngModel)]="filtroBusqueda"
        (input)="aplicarFiltroBusqueda()"
        placeholder="Nombre del tanque...">
    </div>

    <button (click)="limpiarFiltros()" class="btn-secundario">
      Limpiar filtros
    </button>

    <button (click)="cargarTanques()" class="btn-primario">
      üîÑ Recargar
    </button>
  </div>

  <!-- ================================================================ -->
  <!-- INFORMACI√ìN DE PAGINACI√ìN -->
  <!-- ================================================================ -->
  @if (!cargando && tanquesFiltrados.length > 0) {
    <div class="pagination-info">
      <p class="results-count">
        üìä Mostrando {{ getRangoTanques() }}
      </p>
    </div>
  }

  <!-- ================================================================ -->
  <!-- ESTADO DE CARGA -->
  <!-- ================================================================ -->
  @if (cargando) {
    <div class="mensaje-cargando">
      <p>‚è≥ Cargando tanques...</p>
    </div>
  }

  <!-- ================================================================ -->
  <!-- MENSAJE DE ERROR -->
  <!-- ================================================================ -->
  @if (error) {
    <div class="mensaje-error">
      <p>‚ùå {{ error }}</p>
    </div>
  }

  <!-- ================================================================ -->
  <!-- GRID DE TANQUES -->
  <!-- ================================================================ -->
  @if (!cargando && !error) {
    <div class="tanques-grid">
      @if (tanquesPaginados.length === 0) {
        <div class="sin-resultados">
          <p>No se encontraron tanques con los filtros aplicados</p>
        </div>
      } @else {
        @for (tanque of tanquesPaginados; track tanque._id) {
          <div class="tanque-card" (click)="seleccionarTanque(tanque)">
            
            <!-- Header con nombre y naci√≥n -->
            <div class="tanque-header">
              <h3>{{ tanque.nombre }}</h3>
              <span class="nacion-badge" [ngClass]="obtenerColorNacion(tanque.nacion)">
                {{ tanque.nacion }}
              </span>
            </div>

            <!-- Imagen del tanque -->
            @if (tanque.imagen_local) {
              <img [src]="tanque.imagen_local" [alt]="tanque.nombre">
            }
            
            <!-- Informaci√≥n b√°sica -->
            <div class="tanque-info">
              <p><strong>Rol:</strong> {{ tanque.rol }}</p>
              <p><strong>Rating</strong> {{ tanque.rating_arcade }}/{{ tanque.rating_realista}}</p>
              <p><strong>Peso:</strong> {{ tanque.peso }} t</p>
              <p><strong>Velocidad:</strong> {{ tanque.velocidad_adelante_arcade }}/{{tanque.velocidad_adelante_realista}} km/h</p>
            </div>

            <!-- Botones de acci√≥n -->
            <div class="tanque-acciones">
              <button 
                (click)="seleccionarTanque(tanque); $event.stopPropagation()" 
                class="btn-ver">
                üëÅÔ∏è Ver
              </button>
              
              @if (isAuthenticated) {
                <button 
                  (click)="editarTanque(tanque!); $event.stopPropagation()" 
                  class="btn-editar">
                  ‚úèÔ∏è Editar
                </button>
                <button 
                  (click)="eliminarTanque(tanque._id!); $event.stopPropagation()" 
                  class="btn-eliminar">
                  üóëÔ∏è
                </button>
              } @else {
                <button 
                  class="btn-disabled"
                  disabled
                  title="Inicia sesi√≥n para editar">
                  üîí Editar
                </button>
              }
            </div>
          </div>
        }
      }
    </div>
  }

  <!-- ================================================================ -->
  <!-- CONTROLES DE PAGINACI√ìN -->
  <!-- ================================================================ -->
  @if (!cargando && tanquesFiltrados.length > tanquesPorPagina) {
    <div class="pagination-container">
      
      <button 
        class="pagination-btn pagination-btn-nav"
        (click)="primeraPagina()"
        [disabled]="paginaActual === 1"
        title="Primera p√°gina">
        ‚èÆÔ∏è
      </button>
      
      <button 
        class="pagination-btn pagination-btn-nav"
        (click)="paginaAnterior()"
        [disabled]="paginaActual === 1"
        title="P√°gina anterior">
        ‚óÄÔ∏è
      </button>
      
      <div class="pagination-numbers">
        @for (pagina of paginasVisibles; track pagina) {
          <button 
            class="pagination-btn pagination-btn-number"
            [class.active]="pagina === paginaActual"
            (click)="irAPagina(pagina)">
            {{ pagina }}
          </button>
        }
      </div>
      
      <button 
        class="pagination-btn pagination-btn-nav"
        (click)="paginaSiguiente()"
        [disabled]="paginaActual === totalPaginas"
        title="P√°gina siguiente">
        ‚ñ∂Ô∏è
      </button>
      
      <button 
        class="pagination-btn pagination-btn-nav"
        (click)="ultimaPagina()"
        [disabled]="paginaActual === totalPaginas"
        title="√öltima p√°gina">
        ‚è≠Ô∏è
      </button>
      
    </div>
    
    <div class="pagination-details">
      <p>P√°gina {{ paginaActual }} de {{ totalPaginas }}</p>
    </div>
  }

  <!-- ================================================================ -->
  <!-- MODAL DE DETALLES DEL TANQUE -->
  <!-- ================================================================ -->
  @if (tanqueSeleccionado) {
    <div class="modal-overlay" (click)="cerrarDetalles()">
      <div class="modal-contenido" (click)="$event.stopPropagation()">
        
        <button class="btn-cerrar" (click)="cerrarDetalles()">‚úï</button>

        <h2>{{ tanqueSeleccionado.nombre }}</h2>

        <div class="detalles-grid">
          <div class="detalle-seccion">
            <h3>Informaci√≥n General</h3>
            <p><strong>Naci√≥n:</strong> {{ tanqueSeleccionado.nacion }}</p>
            <p><strong>Rol:</strong> {{ tanqueSeleccionado.rol }}</p>
            <p><strong>Rating:</strong> {{ tanqueSeleccionado.rating_arcade }}/{{ tanqueSeleccionado.rating_realista }}</p>
            <p><strong>Tripulaci√≥n:</strong> {{ tanqueSeleccionado.tripulacion }}</p>
          </div>

          <div class="detalle-seccion">
            <h3>Caracter√≠sticas</h3>
            <p><strong>Peso:</strong> {{ tanqueSeleccionado.peso }} toneladas</p>
            <p><strong>Visibilidad:</strong> {{ tanqueSeleccionado.visibilidad }}%</p>
            <p><strong>Blindaje chasis:</strong> {{ tanqueSeleccionado.blindaje_chasis }} mm</p>
            <p><strong>Blindaje torreta:</strong> {{ tanqueSeleccionado.blindaje_torreta }} mm</p>
          </div>

          <div class="detalle-seccion">
            <h3>Movilidad</h3>
            <p><strong>Velocidad adelante:</strong> {{ tanqueSeleccionado.velocidad_adelante_arcade }}/{{ tanqueSeleccionado.velocidad_adelante_realista }} km/h</p>
            <p><strong>Velocidad atr√°s:</strong> {{ tanqueSeleccionado.velocidad_atras_arcade }}/{{ tanqueSeleccionado.velocidad_atras_realista }} km/h</p>
            <p><strong>Potencia/Peso:</strong> {{ tanqueSeleccionado.relacion_potencia_peso }}/{{ tanqueSeleccionado.relacion_potencia_peso_realista }} hp/t</p>
          </div>

          <div class="detalle-seccion">
            <h3>Armamento</h3>
            <p><strong>Recarga:</strong> {{ tanqueSeleccionado.recarga }}s</p>
            <p><strong>Cadencia:</strong> {{ tanqueSeleccionado.cadencia.toFixed(2) }} disparos/min</p>
            <p><strong>Munici√≥n total:</strong> {{ tanqueSeleccionado.municion_total }}</p>
            <p><strong>Depresi√≥n:</strong> {{ tanqueSeleccionado.angulo_depresion }}¬∞</p>
            <p><strong>Elevaci√≥n:</strong> {{ tanqueSeleccionado.angulo_elevacion }}¬∞</p>
            @if (tanqueSeleccionado.rotacion_torreta_horizontal_arcade) {
              <p><strong>Rotaci√≥n lateral de la torreta:</strong> {{ tanqueSeleccionado.rotacion_torreta_horizontal_arcade }}/{{tanqueSeleccionado.rotacion_torreta_horizontal_realista}}¬∫/s</p>
            }
            @if (tanqueSeleccionado.rotacion_torreta_vertical_arcade) {
              <p><strong>Rotaci√≥n vertical de la torreta:</strong> {{ tanqueSeleccionado.rotacion_torreta_vertical_arcade }}/{{tanqueSeleccionado.rotacion_torreta_vertical_realista}}¬∫/s</p>
            }
          </div>
        </div>

        @if (tanqueSeleccionado.armamento) {
          <div class="setup-seccion">
            <h3>üî´ Armamento Detallado</h3>
            @for (armaKey of Object.keys(tanqueSeleccionado.armamento); track armaKey) {
              <div class="arma-detalle">
                <h4>{{ armaKey }}</h4>
                @for (municion of tanqueSeleccionado.armamento[armaKey].municiones; track $index) {
                  <div class="municion-detalle">
                    <p><strong>{{ municion.nombre }}</strong> ({{ municion.tipo }})</p>
                    <ul class="penetracion-lista">
                      <li>0m: {{ municion.penetracion_mm[0] }}mm</li>
                      <li>100m: {{ municion.penetracion_mm[1] }}mm</li>
                      <li>500m: {{ municion.penetracion_mm[2] }}mm</li>
                      <li>1000m: {{ municion.penetracion_mm[3] }}mm</li>
                      <li>1500m: {{ municion.penetracion_mm[4] }}mm</li>
                      <li>2000m: {{ municion.penetracion_mm[5] }}mm</li>
                    </ul>
                  </div>
                }
              </div>
            }
          </div>
        }
      </div>
    </div>
  }
</div>