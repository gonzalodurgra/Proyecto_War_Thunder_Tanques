<div class="container">
  
  <!-- ================================================================ -->
  <!-- HEADER CON AUTENTICACI√ìN -->
  <!-- ================================================================ -->
  <div class="app-header">
    <h1>üéÆ War Thunder - Base de Datos de Tanques</h1>
    
    <div class="user-section">
      @if (isAuthenticated) {
        <!-- Usuario autenticado -->
        <div class="user-menu">
          <button class="user-button" (click)="toggleMenuUsuario()">
            <span class="user-icon">üë§</span>
            <span class="username">{{ currentUsername }}</span>
            <span class="dropdown-icon">‚ñº</span>
          </button>
          
          @if (mostrarMenuUsuario) {
            <div class="dropdown-menu">
              <div class="user-info">
                <p><strong>{{ currentUsername }}</strong></p>
                <p class="user-role">Editor</p>
              </div>
              <button class="dropdown-item logout" (click)="logout()">
                üö™ Cerrar Sesi√≥n
              </button>
            </div>
          }
        </div>
      } @else {
        <!-- Usuario no autenticado -->
        <div class="guest-section">
          <span class="guest-badge">üëÅÔ∏è Modo Lectura</span>
          <button class="btn-login-header" (click)="irALogin()">
            Iniciar Sesi√≥n
          </button>
        </div>
      }
    </div>
  </div>

  <!-- ================================================================ -->
  <!-- SECCI√ìN DE FILTROS -->
  <!-- ================================================================ -->
  <div class="filtros-container">
    <div class="filtros-header">
      <h2>Filtros</h2>
      
      <!-- Bot√≥n Crear Nuevo (solo para usuarios autenticados) -->
      @if (isAuthenticated) {
        <button (click)="crearNuevoTanque()" class="btn-crear-nuevo">
          ‚ûï Crear Nuevo Tanque
        </button>
      }
    </div>
    
    <!-- Filtro por naci√≥n -->
    <div class="filtro">
      <label for="filtroNacion">Naci√≥n:</label>
      <select 
        id="filtroNacion" 
        [(ngModel)]="filtroNacion" 
        (change)="filtrarPorNacion()">
        <option value="">Todas las naciones</option>
        @for (nacion of naciones; track nacion) {
          <option [value]="nacion">{{ nacion }}</option>
        }
      </select>
    </div>

    <!-- Filtro por b√∫squeda -->
    <div class="filtro">
      <label for="filtroBusqueda">Buscar:</label>
      <input 
        type="text" 
        id="filtroBusqueda" 
        [(ngModel)]="filtroBusqueda"
        (input)="aplicarFiltroBusqueda()"
        placeholder="Nombre del tanque...">
    </div>

    <!-- Bot√≥n para limpiar filtros -->
    <button (click)="limpiarFiltros()" class="btn-secundario">
      Limpiar filtros
    </button>

    <!-- Bot√≥n para recargar -->
    <button (click)="cargarTanques()" class="btn-primario">
      üîÑ Recargar
    </button>
  </div>

  <!-- ================================================================ -->
  <!-- ESTADO DE CARGA -->
  <!-- ================================================================ -->
  @if (cargando) {
    <div class="mensaje-cargando">
      <p>Cargando tanques...</p>
    </div>
  }

  <!-- ================================================================ -->
  <!-- MENSAJE DE ERROR -->
  <!-- ================================================================ -->
  @if (error) {
    <div class="mensaje-error">
      <p>{{ error }}</p>
    </div>
  }

  <!-- ================================================================ -->
  <!-- LISTA DE TANQUES -->
  <!-- ================================================================ -->
  @if (!cargando && !error) {
    <div class="tanques-grid">
      @for (tanque of tanquesFiltrados; track tanque._id) {
        <div class="tanque-card" (click)="seleccionarTanque(tanque)">
          
          <!-- Header con nombre y naci√≥n -->
          <div class="tanque-header">
            <h3>{{ tanque.nombre }}</h3>
            <span class="nacion-badge" [ngClass]="obtenerColorNacion(tanque.nacion)">
              {{ tanque.nacion }}
            </span>
            <img [src]="tanque.imagen" alt="imagen del tanque">
          </div>

          <!-- Informaci√≥n b√°sica -->
          <div class="tanque-info">
            <p><strong>Rol:</strong> {{ tanque.rol }}</p>
            <p><strong>Rating:</strong> {{ tanque.rating_arcade }}</p>
            <p><strong>Peso:</strong> {{ tanque.peso }} t</p>
            <p><strong>Velocidad:</strong> {{ tanque.velocidad_adelante_arcade }} km/h</p>
          </div>

          <!-- Botones de acci√≥n -->
          <div class="tanque-acciones">
            <button 
              (click)="seleccionarTanque(tanque); $event.stopPropagation()" 
              class="btn-ver">
              Ver detalles
            </button>
            
            <!-- Botones solo para usuarios autenticados -->
            @if (isAuthenticated) {
              <button 
                (click)="editarTanque(tanque); $event.stopPropagation()" 
                class="btn-editar">
                ‚úèÔ∏è Editar
              </button>
              <button 
                (click)="eliminarTanque(tanque._id!); $event.stopPropagation()" 
                class="btn-eliminar">
                üóëÔ∏è Eliminar
              </button>
            } @else {
              <button 
                class="btn-disabled"
                disabled
                title="Inicia sesi√≥n para editar">
                üîí Editar
              </button>
            }
          </div>
        </div>
      } @empty {
        <!-- Mensaje si no hay tanques -->
        <div class="sin-resultados">
          <p>No se encontraron tanques con los filtros seleccionados</p>
        </div>
      }
    </div>
  }

  <!-- ================================================================ -->
  <!-- MODAL DE DETALLES DEL TANQUE -->
  <!-- ================================================================ -->
  @if (tanqueSeleccionado) {
    <div class="modal-overlay" (click)="cerrarDetalles()">
      <div class="modal-contenido" (click)="$event.stopPropagation()">
        
        <!-- Bot√≥n cerrar -->
        <button class="btn-cerrar" (click)="cerrarDetalles()">‚úï</button>

        <!-- T√≠tulo -->
        <h2>{{ tanqueSeleccionado.nombre }}</h2>

        <!-- Informaci√≥n detallada -->
        <div class="detalles-grid">
          <div class="detalle-seccion">
            <h3>Informaci√≥n General</h3>
            <p><strong>Naci√≥n:</strong> {{ tanqueSeleccionado.nacion }}</p>
            <p><strong>Rol:</strong> {{ tanqueSeleccionado.rol }}</p>
            <p><strong>Rating:</strong> {{ tanqueSeleccionado.rating_arcade }}</p>
            <p><strong>Tripulaci√≥n:</strong> {{ tanqueSeleccionado.tripulacion }}</p>
          </div>

          <div class="detalle-seccion">
            <h3>Caracter√≠sticas</h3>
            <p><strong>Peso:</strong> {{ tanqueSeleccionado.peso }} toneladas</p>
            <p><strong>Visibilidad:</strong> {{ tanqueSeleccionado.visibilidad }}%</p>
            <p><strong>Blindaje chasis:</strong> {{ tanqueSeleccionado.blindaje_chasis }} mm</p>
            <p><strong>Blindaje torreta:</strong> {{ tanqueSeleccionado.blindaje_torreta }} mm</p>
          </div>

          <div class="detalle-seccion">
            <h3>Movilidad</h3>
            <p><strong>Velocidad adelante:</strong> {{ tanqueSeleccionado.velocidad_adelante_arcade }} km/h</p>
            <p><strong>Velocidad atr√°s:</strong> {{ tanqueSeleccionado.velocidad_atras_arcade }} km/h</p>
            <p><strong>Potencia/Peso:</strong> {{ tanqueSeleccionado.relacion_potencia_peso }} hp/t</p>
          </div>

          <div class="detalle-seccion">
            <h3>Armamento</h3>
            <p><strong>Recarga:</strong> {{ tanqueSeleccionado.recarga }}s</p>
            <p><strong>Cadencia:</strong> {{ tanqueSeleccionado.cadencia.toFixed(2) }} disparos/min</p>
            <p><strong>Munici√≥n total:</strong> {{ tanqueSeleccionado.municion_total }}</p>
            <p><strong>Depresi√≥n:</strong> {{ tanqueSeleccionado.angulo_depresion }}¬∞</p>
            <p><strong>Elevaci√≥n:</strong> {{ tanqueSeleccionado.angulo_elevacion }}¬∞</p>
          </div>
        </div>

        <!-- Setup de armas 1 -->
        @if (tanqueSeleccionado.setup_1) {
          <div class="setup-seccion">
            <h3>Setup 1</h3>
            @for (arma of obtenerArmasSetup(tanqueSeleccionado.setup_1); track arma.nombre) {
              <div>
                <h4>{{ arma.nombre }}</h4>
                <ul>
                  @for (municion of arma.municiones; track municion.nombre) {
                    <li>
                      {{ municion.nombre }} ({{ municion.tipo }}) - 
                      Penetraci√≥n: {{ municion.penetracion_mm[0] }}mm
                    </li>
                  }
                </ul>
              </div>
            }
          </div>
        }

        <!-- Setup de armas 2 -->
        @if (tanqueSeleccionado.setup_2) {
          <div class="setup-seccion">
            <h3>Setup 2</h3>
            @for (arma of obtenerArmasSetup(tanqueSeleccionado.setup_2); track arma.nombre) {
              <div>
                <h4>{{ arma.nombre }}</h4>
                <ul>
                  @for (municion of arma.municiones; track municion.nombre) {
                    <li>
                      {{ municion.nombre }} ({{ municion.tipo }}) - 
                      Penetraci√≥n: {{ municion.penetracion_mm[0] }}mm
                    </li>
                  }
                </ul>
              </div>
            }
          </div>
        }

        <!-- Armamento (con detalles expandidos de penetraci√≥n) -->
        @if (tanqueSeleccionado.armamento) {
          <div class="setup-seccion">
            <h3>Armamento</h3>
            @for (arma of obtenerArmasSetup(tanqueSeleccionado.armamento); track arma.nombre) {
              <div>
                <h4>{{ arma.nombre }}</h4>
                <ul>
                  @for (municion of arma.municiones; track municion.nombre) {
                    <li>
                      {{ municion.nombre }} ({{ municion.tipo }})
                      <ul>
                        <li>Penetraci√≥n a 0 metros: {{ municion.penetracion_mm[0] }}mm</li>
                        <li>Penetraci√≥n a 100 metros: {{ municion.penetracion_mm[1] }}mm</li>
                        <li>Penetraci√≥n a 500 metros: {{ municion.penetracion_mm[2] }}mm</li>
                        <li>Penetraci√≥n a 1000 metros: {{ municion.penetracion_mm[3] }}mm</li>
                        <li>Penetraci√≥n a 1500 metros: {{ municion.penetracion_mm[4] }}mm</li>
                        <li>Penetraci√≥n a 2000 metros: {{ municion.penetracion_mm[5] }}mm</li>
                      </ul>
                    </li>
                  }
                </ul>
              </div>
            }
          </div>
        }
      </div>
    </div>
  }
</div>